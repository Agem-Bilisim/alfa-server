<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorator="layouts/dashboard">
<head>
	<title>Bilgisayar Envanteri</title>
	<!-- DataTables -->
	<link th:href="@{/plugins/DataTables/datatables.min.css}" rel="stylesheet" />
</head>
<body>
	<th:block layout:fragment="breadcrumb-list">
		<li class="active">Bilgisayar Envanteri</li>
	</th:block>

	<div layout:fragment="content">
		<div class="row">
			<div class="col-xs-12">
				<div class="box">
					<div class="box-header">
						<h3 class="box-title">Bilgisayar listesi</h3>
					</div>
					<div class="box-body">
						<table id="agentTable" class="table table-bordered table-striped">
							<thead>
								<tr>
									<th>Hostname</th>
									<th>IP Adresleri</th>
									<th>MAC Adresleri</th>
									<th>İşlem</th>
								</tr>
							</thead>
							<tbody>
							</tbody>
						</table>
					</div>
				</div>					
			</div>
		</div>
		
		<!-- Agent details modal -->
		<div
			layout:insert="layouts/info-modal :: modal(modalId='agentDetailModal', modalHeader='Agent Details', modalButton='Kapat')"
			th:remove="tag">
			<div class="nav-tabs-custom" layout:fragment="modal-content">
				<ul class="nav nav-tabs">
					<li class="active"><a href="#tab_1" data-toggle="tab">Genel</a></li>
              		<li><a href="#tab_2" data-toggle="tab">Yazılımlar</a></li>
              		<li><a href="#tab_3" data-toggle="tab">Kullanıcılar</a></li>
				</ul>
				<div class="tab-content">
					<div class="tab-pane active" id="tab_1">
						<dl class="dl-horizontal">
							<dt>Hostname</dt>
							<dd id="agentHostname"></dd>
							<dd id="agentOnline"></dd>
							<dt>MAC adresi</dt>
							<dd id="agentMacAddresses"></dd>
							<dt>IP adresi</dt>
							<dd id="agentIpAddresses"></dd>
							<dt>Türü</dt>
							<dd id="agentType"></dd>
							<dt>Son kurulum</dt>
							<dd id="agentLastInstallationDate"></dd>
						</dl>
					</div>
					<div class="tab-pane" id="tab_2">
						<table id="agentPackagesTable" class="table table-bordered table-striped" style="width: 100%;">
							<thead>
								<tr>
									<th>Paket adı</th>
									<th>Sürüm</th>
								</tr>
							</thead>
							<tbody id="agentPackagesTableBody"></tbody>
						</table>
					</div>
					<div class="tab-pane" id="tab_3">
						<table id="agentUsersTable" class="table table-bordered table-striped" style="width: 100%;">
							<thead>
								<tr>
									<th>Kullanıcı adı</th>
								</tr>
							</thead>
							<tbody id="agentUsersTableBody"></tbody>
						</table>
					</div>
				</div>
			</div>
		</div>
		
	</div>
	<script layout:fragment="custom-script" th:inline="javascript">
		var dateFormat = /*[[${applicationDateFormat}]]*/ 'dd/mm/yyyy';
		var agentPackagesTable = null;
		var agentUsersTable = null;
	
		var handleDetailsModal = function(agentId) {
			$.ajax({
				type : "GET",
				contentType : "application/json",
				url : "/alfa/agent/" + agentId + "/detail",
				dataType : 'json',
				cache : false,
				timeout : 600000,
				success : function(result) {
					console.log(JSON.stringify(result));
					if (result && result.data && result.data.agent) {
						// General
						$("#agentHostname").html(result.data.agent['hostName']);
						$("#agentOnline").html(result.data['online-status'] ? "<i class=\"fa fa-circle text-success\"></i> Çevrimiçi" 
								: "<i class=\"fa fa-circle text-error\"></i> Çevrimdışı");
						$("#agentMacAddresses").html(result.data.agent['macAddresses']);
						$("#agentIpAddresses").html(result.data.agent['ipAddresses']);
						$("#agentType").html(result.data.agent['type']);
						$("#agentLastInstallationDate").html(result.data.agent['lastInstallationDate']);
						
						// Packages
						$('#agentPackagesTableBody').html("");
						if (result.data.agent.installedPackages) {
							for (var index in result.data.agent['installedPackages']) {
								var prop = result.data.agent['installedPackages'][index];
								$('#agentPackagesTableBody').append('<tr><td>' + prop['name'] + '</td><td>' + prop['version'] + '</td></tr>');
							}
							if (agentPackagesTable) {
								agentPackagesTable.draw('full-reset');
							} else {
								agentPackagesTable = $('#agentPackagesTable').DataTable({
									"language": {
									    "sDecimal":        ",",
									    "sEmptyTable":     "Tabloda herhangi bir veri mevcut değil",
									    "sInfo":           "_TOTAL_ kayıttan _START_ - _END_ arasındaki kayıtlar gösteriliyor",
									    "sInfoEmpty":      "Kayıt yok",
									    "sInfoFiltered":   "(_MAX_ kayıt içerisinden bulunan)",
									    "sInfoPostFix":    "",
									    "sInfoThousands":  ".",
									    "sLengthMenu":     "Sayfada _MENU_ kayıt göster",
									    "sLoadingRecords": "Yükleniyor...",
									    "sProcessing":     "İşleniyor...",
									    "sSearch":         "Ara:",
									    "sZeroRecords":    "Eşleşen kayıt bulunamadı",
									    "oPaginate": {
									        "sFirst":    "İlk",
									        "sLast":     "Son",
									        "sNext":     "Sonraki",
									        "sPrevious": "Önceki"
									    },
									    "oAria": {
									        "sSortAscending":  ": artan sütun sıralamasını aktifleştir",
									        "sSortDescending": ": azalan sütun sıralamasını aktifleştir"
									    }
									},
									"deferRender": true,
									"responsive": true,
								});
							}
						}
						
						// Users
						$('#agentUsersTableBody').html("");
						if (result.data.agent.users) {
							for (var index in result.data.agent['users']) {
								var prop = result.data.agent['users'][index];
								$('#agentUsersTableBody').append('<tr><td>' + prop['name'] + '</td></tr>');
							}
							if (agentUsersTable) {
								agentUsersTable.draw('full-reset');
							} else {
								agentUsersTable = $('#agentUsersTable').DataTable({
									"language": {
									    "sDecimal":        ",",
									    "sEmptyTable":     "Tabloda herhangi bir veri mevcut değil",
									    "sInfo":           "_TOTAL_ kayıttan _START_ - _END_ arasındaki kayıtlar gösteriliyor",
									    "sInfoEmpty":      "Kayıt yok",
									    "sInfoFiltered":   "(_MAX_ kayıt içerisinden bulunan)",
									    "sInfoPostFix":    "",
									    "sInfoThousands":  ".",
									    "sLengthMenu":     "Sayfada _MENU_ kayıt göster",
									    "sLoadingRecords": "Yükleniyor...",
									    "sProcessing":     "İşleniyor...",
									    "sSearch":         "Ara:",
									    "sZeroRecords":    "Eşleşen kayıt bulunamadı",
									    "oPaginate": {
									        "sFirst":    "İlk",
									        "sLast":     "Son",
									        "sNext":     "Sonraki",
									        "sPrevious": "Önceki"
									    },
									    "oAria": {
									        "sSortAscending":  ": artan sütun sıralamasını aktifleştir",
									        "sSortDescending": ": azalan sütun sıralamasını aktifleştir"
									    }
									},
									"deferRender": true,
									"responsive": true,
								});
							}
						}
						
						
						// Show modal
						$('#agentDetailModal').modal('show');
					}
				}
			});
		};
	
		$(function() {
			// Agent
			var fnActionBtnsAgent = function(row, type, val, meta) {
				return "<button class=\"btn btn-outline-primary\" onclick=\"return handleDetailsModal(" + row["id"] + ");\"><i class=\"fa fa-info\"></i> Detaylar</button>";
			};
			const colsAgent = [
				{"data": "hostName", "searchable": true, "orderable": true }, 
				{"data": "ipAddresses", "searchable": true, "orderable": true }, 
				{"data": "macAddresses", "searchable": true, "orderable": true }, 
				{"data": fnActionBtnsAgent, "searchable": false, "orderable": false }
			];
			$('#agentTable').paginatedTable("/alfa/agent/list-paginated", "agents", colsAgent, null);
		});
	</script>
</body>
</html>
